---
# Validating variables(parts) that can't be validated via argument_specs
- name: Validate common settings config
  ansible.utils.validate:
    data: "{{ bambuddy_common_settings }}"
    criteria:
      - "{{ lookup('file',  '../criteria/bambuddy_common_settings.json') | from_json }}"
    engine: ansible.utils.jsonschema
  when: bambuddy_common_settings.keys() | length > 0

- name: Validate printers config
  ansible.utils.validate:
    data: "{{ bambuddy_printers }}"
    criteria:
      - "{{ lookup('file',  '../criteria/bambuddy_printers.json') | from_json }}"
    engine: ansible.utils.jsonschema
  when: bambuddy_printers.keys() | length > 0

# Start of execution
- name: Fetch API token
  nils_ost.bambuddy.token:
    host: "{{ ansible_host }}"
    port: "{{ bambuddy_port }}"
    user: "{{ bambuddy_user | default(omit) }}"
    password: "{{ bambuddy_user_password | default(omit) }}"
  delegate_to: localhost
  register: bambuddy

- name: Configure common settings
  nils_ost.bambuddy.settings:
    url: "{{ bambuddy.url }}"
    token: "{{ bambuddy.token }}"
    ams_humidity_fair: "{{ bambuddy_common_settings.ams_humidity_fair | default(omit) }}"
    ams_humidity_good: "{{ bambuddy_common_settings.ams_humidity_good | default(omit) }}"
    ams_temp_fair: "{{ bambuddy_common_settings.ams_temp_fair | default(omit) }}"
    ams_temp_good: "{{ bambuddy_common_settings.ams_temp_good | default(omit) }}"
    auto_archive: "{{ bambuddy_common_settings.auto_archive | default(omit) }}"
    capture_finish_photo: "{{ bambuddy_common_settings.capture_finish_photo | default(omit) }}"
    save_thumbnails: "{{ bambuddy_common_settings.save_thumbnails | default(omit) }}"
    camera_view_mode: "{{ bambuddy_common_settings.camera_view_mode | default(omit) }}"
    check_printer_firmware: "{{ bambuddy_common_settings.check_printer_firmware | default(omit) }}"
    check_updates: "{{ bambuddy_common_settings.check_updates | default(omit) }}"
    currency: "{{ bambuddy_common_settings.currency | default(omit) }}"
    default_filament_cost: "{{ bambuddy_common_settings.default_filament_cost | default(omit) }}"
    energy_cost_per_kwh: "{{ bambuddy_common_settings.energy_cost_per_kwh | default(omit) }}"
    energy_tracking_mode: "{{ bambuddy_common_settings.energy_tracking_mode | default(omit) }}"
    external_url: "{{ bambuddy_common_settings.external_url | default(omit) }}"
    ha_enabled: "{{ bambuddy_common_settings.ha_enabled | default(omit) }}"
    ha_token: "{{ bambuddy_common_settings.ha_token | default(omit) }}"
    ha_url: "{{ bambuddy_common_settings.ha_url | default(omit) }}"
    library_archive_mode: "{{ bambuddy_common_settings.library_archive_mode | default(omit) }}"
    library_disk_warning_gb: "{{ bambuddy_common_settings.library_disk_warning_gb | default(omit) }}"
    prometheus_enabled: "{{ bambuddy_common_settings.prometheus_enabled | default(omit) }}"
    prometheus_token: "{{ bambuddy_common_settings.prometheus_token | default(omit) }}"
  delegate_to: localhost

- name: Configure virtual printer
  nils_ost.bambuddy.virtual_printer:
    url: "{{ bambuddy.url }}"
    token: "{{ bambuddy.token }}"
    enabled: "{{ bambuddy_virtual_printer.enabled | default(omit) }}"
    accesscode: "{{ bambuddy_virtual_printer.accesscode | default(omit) }}"
    model: "{{ bambuddy_virtual_printer.model | default(omit) }}"
    mode: "{{ bambuddy_virtual_printer.mode | default(omit) }}"
  delegate_to: localhost

- name: Pulling existing printers
  nils_ost.bambuddy.list:
    url: "{{ bambuddy.url }}"
    token: "{{ bambuddy.token }}"
    target: printer
  delegate_to: localhost
  register: existing_printers

- name: Purging unconfigured printers
  nils_ost.bambuddy.printer:
    url: "{{ bambuddy.url }}"
    token: "{{ bambuddy.token }}"
    name: "{{ existing_printer_id }}"
    state: "absent"
  delegate_to: localhost

  when: existing_printer_id not in bambuddy_printers

  vars:
    existing_printer_id: "{{ existing_printer_item.name }}"

  loop_control:
    loop_var: existing_printer_item
    label: "{{ existing_printer_item.name }}"
  with_items: "{{ existing_printers.data }}"

- name: Creating printers
  nils_ost.bambuddy.printer:
    url: "{{ bambuddy.url }}"
    token: "{{ bambuddy.token }}"
    name: "{{ printer_id }}"

    ip_address: "{{ printer.ip_address | default(omit) }}"
    serial_number: "{{ printer.serial_number | default(omit) }}"
    access_code: "{{ printer.access_code | default(omit) }}"
    model: "{{ printer.model | default(omit) }}"
    location: "{{ printer.location | default(omit) }}"
    auto_archive: "{{ printer.auto_archive | default(omit) }}"

    state: "present"
  delegate_to: localhost

  vars:
    printer: "{{ printer_item.value }}"
    printer_id: "{{ printer_item.key }}"

  loop_control:
    loop_var: printer_item
    label: "{{ printer_item.key }}"
  with_dict: "{{ bambuddy_printers }}"
  register: created_printers
